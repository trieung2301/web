<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Shop Demo - Lịch Sử Mua Hàng</title>
    <link rel="stylesheet" href="../Css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">
                <img src="https://tse3.mm.bing.net/th/id/OIP.IhOrqGoCi8SNaOHRVsw-VQHaHa?pid=Api&P=0&h=220" alt="Logo Shop" height="40">
                <span class="shop-name">Shop Demo</span>
            </a>
            <form class="search-form" id="searchForm">
                <input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm..." />
                <button type="submit">🔍</button>
            </form>
            <div class="user-area">
                <a href="login.html" id="loginLink">Đăng nhập</a>
                <a href="register.html" id="registerLink">Đăng ký</a>
                <a href="javascript:void(0);" id="logoutLink" onclick="handleLogout()" style="display:none;">Đăng xuất</a>
                <a href="admin-panel.html" id="adminPanelLink" style="display:none;">Admin</a>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="container">
            <ul class="nav-list">
                <li><a href="index.html" id="homeNavLink">Trang chủ</a></li>
                <li><a href="category.html" id="categoriesNavLink">Danh mục</a></li>
                <li><a href="flash-sale.html" id="flashSaleNavLink">Flash Sale</a></li>
                <li><a href="top-deal.html" id="topDealNavLink">Top Deal</a></li>
                <li><a href="purchasehistory.html" class="current-page">Lịch Sử Mua Hàng</a></li>
            </ul>
            <div class="cart-icon" id="cart-icon">
                <a href="cart.html">
                    🛒 Giỏ hàng
                    <span id="cart-count">(0)</span>
                </a>
                <div class="mini-cart" id="mini-cart"></div>
            </div>
        </div>
    </nav>

    <main class="history-page">
        <div class="container">
            <h1>Lịch Sử Mua Hàng Của Bạn</h1>
            <div id="ordersContainer" class="orders-grid"></div>
        </div>
    </main>

    <script src="../JavaScript/products.js"></script>
    <script src="../JavaScript/searchHandler.js"></script>
    <script src="../JavaScript/cart.js"></script>
    <script src="../JavaScript/user.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const container = document.getElementById("ordersContainer");

            // Cập nhật giao diện đăng nhập/đăng ký/đăng xuất và giỏ hàng
            updateAuthUI();
            updateCartCount();

            if (!currentUser || !currentUser.username) { // Kiểm tra currentUser.username
                container.innerHTML = "<p>Vui lòng <a href='login.html'>đăng nhập</a> để xem lịch sử mua hàng của bạn.</p>";
                return;
            }

            // Lấy tất cả các đơn hàng từ localStorage, sử dụng key "orders"
            const allOrders = JSON.parse(localStorage.getItem("orders")) || [];
            // Lọc các đơn hàng chỉ thuộc về người dùng hiện tại
            const userOrders = allOrders.filter(order => order.userId === currentUser.username);

            // Cần lấy allItemsData và tạo lại đối tượng Item để sử dụng các phương thức
            const storedItemsData = JSON.parse(localStorage.getItem('allItemsData')) || [];
            const allItems = storedItemsData.map(data => new Item(
                data.id, data.name, data.price, data.imageUrl, data.description,
                data.category, data.stock, data.isFlashSale, data.originalPrice,
                data.salePrice, data.soldQuantity
            ));

            // Tạo một instance Item tạm thời để sử dụng getFormattedPrice
            const tempItemInstance = new Item(0, '', 0);

            if (userOrders.length === 0) {
                container.innerHTML = "<p>Bạn chưa có đơn hàng nào.</p>";
                return;
            }

            // Sắp xếp đơn hàng theo ngày, mới nhất trước
            userOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            userOrders.forEach((order) => {
                const orderDiv = document.createElement("div");
                orderDiv.className = "order-item";

                let itemsHTML = "";
                // Hiển thị tối đa 3 sản phẩm, sau đó thêm "..." nếu có nhiều hơn
                const itemsToDisplay = order.items.slice(0, 3);
                itemsToDisplay.forEach(cartItem => {
                    // Tìm sản phẩm trong allItems (đã được chuyển thành đối tượng Item)
                    const itemData = allItems.find(p => p.id === cartItem.id);
                    // Dùng thông tin từ cartItem nếu itemData không tìm thấy (sản phẩm có thể đã bị xóa khỏi hệ thống)
                    const displayItemName = itemData ? itemData.name : `Sản phẩm không khả dụng (ID: ${cartItem.id})`;
                    const displayItemImage = itemData ? itemData.imageUrl : 'https://via.placeholder.com/50?text=No+Image'; // Placeholder image
                    const displayItemPrice = cartItem.price; // Luôn dùng giá lưu trong đơn hàng để đảm bảo chính xác

                    itemsHTML += `
                        <div class="product">
                            <img src="${displayItemImage}" alt="${displayItemName}" width="50" height="50">
                            <div class="info">
                                <strong>${displayItemName}</strong><br>
                                Số lượng: ${cartItem.quantity}<br>
                                Giá: ${tempItemInstance.getFormattedPrice(displayItemPrice * cartItem.quantity)}
                            </div>
                        </div>
                    `;
                });

                if (order.items.length > 3) {
                    itemsHTML += `<p class="more-items">... và ${order.items.length - 3} sản phẩm khác</p>`;
                }

                orderDiv.innerHTML = `
                    <div class="order-summary">
                        <p><strong>Mã đơn hàng:</strong> #${order.orderId}</p>
                        <p><strong>Ngày đặt:</strong> ${order.orderDate}</p>
                        <p><strong>Tổng tiền:</strong> ${tempItemInstance.getFormattedPrice(order.totalAmount)}</p>
                        <p><strong>Trạng thái:</strong> <span style="font-weight: bold; color: ${order.status === 'Đang chờ xác nhận' ? 'orange' : 'green'};">${order.status}</span></p>
                        <button onclick="viewOrder('${order.orderId}')">Xem chi tiết</button>
                    </div>
                    <div class="products">${itemsHTML}</div>
                `;

                container.appendChild(orderDiv);
            });
        });

        function viewOrder(orderId) {
            localStorage.setItem("viewOrderId", orderId);
            window.location.href = "purchase.html"; // Chuyển hướng đến trang chi tiết đơn hàng
        }
    </script>
    <footer class="footer">
        <div class="footer-content">
            <p>Bản quyền © 2025 Shop Demo</p>
            <div class="contact-links">
                <ul>
                    <li><a href="https://www.facebook.com/TTCSNH/" target="_blank">Facebook</a></li>
                    <li><a href="tel:+84123456789">Số điện thoại: 08 3334 3334</a></li>
                </ul>
            </div>

            <div class="contact-links">
                <a href="policy.html" style="margin: 0 10px;">Chính sách mua hàng</a>
                <a href="policy-protect.html" style="margin: 0 10px;">Chính sách bảo mật</a>
            </div>
        </div>
    </footer>
</body>
</html>